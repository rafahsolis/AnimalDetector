services:
  label-studio:
    image: heartexlabs/label-studio:latest
    container_name: animal-detector-label-studio
    environment:
      - LABEL_STUDIO_EXTRA_SETTINGS=/label-studio/custom_settings.py
      - LABEL_STUDIO_LOCAL_FILES_SERVING_ENABLED=true
      - LABEL_STUDIO_LOCAL_FILES_DOCUMENT_ROOT=/datasets
      - LABEL_STUDIO_HOSTNAME=https://label.montedelavilla.org
      - LABEL_STUDIO_HOST=https://label.montedelavilla.org
      - CSRF_TRUSTED_ORIGINS=https://label.montedelavilla.org
      - SSRF_PROTECTION_ENABLED=false
      - LABEL_STUDIO_DISABLE_SIGNUP_WITHOUT_LINK=false
      - DJANGO_DB=default
      - POSTGRE_NAME=labelstudio
      - POSTGRE_USER=postgres
      - POSTGRE_PASSWORD=postgres
      - POSTGRE_PORT=5432
      - POSTGRE_HOST=db
    entrypoint: ["/bin/bash", "-c"]
    command: ["label-studio"]
    ports:
      - "8080:8080"
    volumes:
      - ../datasets:/datasets:ro
      - ./data:/label-studio/data
      - ./custom_settings.py:/label-studio/custom_settings.py:ro
    restart: unless-stopped
    stdin_open: true
    tty: true
    depends_on:
      - db

  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: animal-detector-cloudflared
    command: tunnel --config /etc/cloudflared/config.yml run
    volumes:
      - ./config.yml:/etc/cloudflared/config.yml:ro
      - /home/rafa/.cloudflared/3663beb6-957e-4620-99bd-65ac5b9187c1.json:/etc/cloudflared/creds.json:ro
    env_file:
      - tunnel.env
    restart: unless-stopped
    depends_on:
      - label-studio
    networks:
      - default

  db:
    image: postgres:15
    container_name: animal-detector-postgres
    environment:
      - POSTGRES_DB=labelstudio
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped

volumes:
  postgres_data:
